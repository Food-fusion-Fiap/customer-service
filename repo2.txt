package repositories

import (
	"errors"
	"strings"

	"github.com/CAVAh/api-tech-challenge/src/core/domain/entities"
	"github.com/CAVAh/api-tech-challenge/src/infra/db/models"
	"gorm.io/gorm"
)

type DBInterface interface {
	Create(value interface{}) *gorm.DB
	Where(query interface{}, args ...interface{}) *gorm.DB
	Find(dest interface{}, conds ...interface{}) *gorm.DB
}

type CustomerRepository struct {
	DB DBInterface
}

func (r CustomerRepository) Create(entity *entities.Customer) (*entities.Customer, error) {
	customer := models.Customer{
		Name:  entity.Name,
		CPF:   entity.CPF,
		Email: entity.Email,
	}

	if err := r.DB.Create(&customer).Error; err != nil {
		if strings.Contains(err.Error(), "duplicate key value violates unique constraint") {
			return nil, errors.New("cliente j√° existe no sistema")
		} else {
			return nil, errors.New("ocorreu um erro desconhecido ao criar o cliente")
		}
	}

	result := customer.ToDomain()

	return &result, nil
}

func (r CustomerRepository) List(entity *entities.Customer) ([]entities.Customer, error) {
	var customers []models.Customer

	if cpf := entity.CPF; cpf != "" {
		r.DB.Where("cpf = ?", cpf).Find(&customers)
	} else {
		r.DB.Find(&customers)
	}

	var response []entities.Customer

	for _, customer := range customers {
		response = append(response, customer.ToDomain())
	}

	return response, nil
}
